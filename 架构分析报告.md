# API Key Manager æ¶æ„åˆ†ææŠ¥å‘Š

**ç‰ˆæœ¬**: 1.0.0  
**åˆ†ææ—¥æœŸ**: 2026å¹´2æœˆ18æ—¥  
**åˆ†æå·¥å…·**: iFlow CLI æ¶æ„åˆ†æå¼•æ“  

---

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [é¡¹ç›®æ•´ä½“æ¶æ„æ¦‚è§ˆ](#é¡¹ç›®æ•´ä½“æ¶æ„æ¦‚è§ˆ)
3. [ç›®å½•ç»“æ„è¯¦ç»†åˆ†æ](#ç›®å½•ç»“æ„è¯¦ç»†åˆ†æ)
4. [å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜](#å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜)
5. [é…ç½®ç®¡ç†æ–¹å¼](#é…ç½®ç®¡ç†æ–¹å¼)
6. [å®‰å…¨æ€§è®¾è®¡è¯¦è§£](#å®‰å…¨æ€§è®¾è®¡è¯¦è§£)
7. [éƒ¨ç½²æ¶æ„å’Œ Docker é…ç½®](#éƒ¨ç½²æ¶æ„å’Œ-docker-é…ç½®)
8. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
9. [æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®](#æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®)
10. [ä¾èµ–æ¸…å•](#ä¾èµ–æ¸…å•)
11. [æ€»ç»“å’Œè¯„åˆ†](#æ€»ç»“å’Œè¯„åˆ†)

---

## æ‰§è¡Œæ‘˜è¦

**API Key Manager** æ˜¯ä¸€ä¸ªç”¨äºé›†ä¸­ç®¡ç†å¤šä¸ª LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰æœåŠ¡å•† API å¯†é’¥çš„ SaaS åº”ç”¨ã€‚é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯åŸºäº **FastAPI** æ¡†æ¶æ„å»ºï¼Œå‰ç«¯ä½¿ç”¨çº¯ HTML/CSS/JavaScript å®ç°ï¼Œæ•°æ®å­˜å‚¨é‡‡ç”¨ **PostgreSQL** æ•°æ®åº“ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- ğŸ”‘ **API å¯†é’¥ç®¡ç†**: æ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ã€æµ‹è¯•å¤šä¸ª LLM æœåŠ¡å•†çš„ API å¯†é’¥
- ğŸ¢ **å¤šæœåŠ¡å•†æ”¯æŒ**: å†…ç½® OpenAIã€Anthropicã€Googleã€DeepSeekã€æ™ºè°±ç­‰ä¸»æµæœåŠ¡å•†
- ğŸ‘¤ **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**: åŸºäº JWT çš„ç”¨æˆ·è®¤è¯ï¼Œæ”¯æŒè§’è‰²æƒé™ç®¡ç†
- ğŸ” **ä¼ä¸šçº§å®‰å…¨**: å¯†é’¥åŠ å¯†å­˜å‚¨ã€åŠ¨æ€ç®¡ç†åå°è·¯å¾„ã€äºŒæ¬¡ç¡®è®¤æœºåˆ¶ã€é™æµä¿æŠ¤
- ğŸ’³ **ä¼šå‘˜è®¢é˜…ç³»ç»Ÿ**: æ”¯æŒå…è´¹ç‰ˆã€åŸºç¡€ç‰ˆã€ä¸“ä¸šç‰ˆä¸‰çº§ä¼šå‘˜ä½“ç³»
- ğŸ“Š **ç®¡ç†åå°**: å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ã€æœåŠ¡å•†ç®¡ç†ã€æ¨¡å‹é…ç½®ã€æ—¥å¿—å®¡è®¡åŠŸèƒ½

### æŠ€æœ¯æ ˆæ¦‚è§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| å‰ç«¯ | HTML5 + CSS3 + Vanilla JavaScript + Lucide Icons |
| åç«¯ | Python 3.13 + FastAPI 0.115.0 |
| æ•°æ®åº“ | PostgreSQL 15 |
| ORM | SQLAlchemy 2.0.35 |
| è®¤è¯ | JWT (python-jose) + bcrypt |
| åŠ å¯† | Fernet (AES-128) + PBKDF2HMAC |
| éƒ¨ç½² | Docker + Nginx åå‘ä»£ç† |

---

## é¡¹ç›®æ•´ä½“æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        Browser[æµè§ˆå™¨å®¢æˆ·ç«¯]
    end
    
    subgraph "å‰ç«¯æœåŠ¡å±‚"
        Nginx[Nginx åå‘ä»£ç†]
        StaticFiles[é™æ€æ–‡ä»¶æœåŠ¡]
        HTML[HTML/CSS/JS]
    end
    
    subgraph "åç«¯æœåŠ¡å±‚"
        FastAPI[FastAPI åº”ç”¨]
        
        subgraph "æ ¸å¿ƒæ¨¡å—"
            Auth[è®¤è¯æ¨¡å—]
            Keys[å¯†é’¥ç®¡ç†]
            Admin[ç®¡ç†åå°]
            TOTP[åŒå› ç´ è®¤è¯]
            Payment[æ”¯ä»˜å›è°ƒ]
        end
        
        subgraph "ä¸­é—´ä»¶"
            LogMiddleware[æ—¥å¿—ä¸­é—´ä»¶]
            SecurityMiddleware[å®‰å…¨ä¸­é—´ä»¶]
            RateLimiter[é™æµä¸­é—´ä»¶]
        end
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚"
        PostgreSQL[(PostgreSQL)]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        LLMProviders[LLM æœåŠ¡å•† API]
    end
    
    Browser --> Nginx
    Nginx --> StaticFiles
    Nginx --> FastAPI
    FastAPI --> Auth
    FastAPI --> Keys
    FastAPI --> Admin
    FastAPI --> TOTP
    FastAPI --> Payment
    Auth --> PostgreSQL
    Keys --> PostgreSQL
    Admin --> PostgreSQL
    TOTP --> PostgreSQL
    Payment --> PostgreSQL
    Keys --> LLMProviders
```

### è¯·æ±‚å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨
    participant Nginx as Nginx
    participant FastAPI as FastAPI æœåŠ¡
    participant Middleware as ä¸­é—´ä»¶é“¾
    participant Router as è·¯ç”±å¤„ç†å™¨
    participant DB as PostgreSQL
    participant External as å¤–éƒ¨ API
    
    User->>Nginx: HTTP è¯·æ±‚
    Nginx->>FastAPI: ä»£ç†è½¬å‘
    
    FastAPI->>Middleware: è¯·æ±‚è¿›å…¥
    Note over Middleware: 1. CORS å¤„ç†<br/>2. æ—¥å¿—è®°å½•<br/>3. é™æµæ£€æŸ¥<br/>4. å®‰å…¨éªŒè¯
    
    Middleware->>Router: éªŒè¯é€šè¿‡
    Router->>DB: æ•°æ®æ“ä½œ
    DB-->>Router: è¿”å›æ•°æ®
    
    alt éœ€è¦è°ƒç”¨å¤–éƒ¨ API
        Router->>External: API è°ƒç”¨
        External-->>Router: å“åº”æ•°æ®
    end
    
    Router-->>Middleware: å“åº”æ•°æ®
    Middleware-->>FastAPI: å¤„ç†å®Œæˆ
    FastAPI-->>Nginx: HTTP å“åº”
    Nginx-->>User: è¿”å›ç»“æœ
```

---

## ç›®å½•ç»“æ„è¯¦ç»†åˆ†æ

```
api-manager/
â”œâ”€â”€ ğŸ“ backend/                    # åç«¯æœåŠ¡ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ ğŸ“„ config.py               # é…ç½®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ database.py             # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“„ models.py               # SQLAlchemy æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ ğŸ“„ schemas.py              # Pydantic æ•°æ®éªŒè¯æ¨¡å‹
â”‚   â”œâ”€â”€ ğŸ“„ auth.py                 # è®¤è¯å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ ğŸ“„ captcha.py              # éªŒè¯ç ç”Ÿæˆæ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ totp_utils.py           # TOTP åŒå› ç´ è®¤è¯å·¥å…·
â”‚   â”œâ”€â”€ ğŸ“„ log_middleware.py       # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ security_middleware.py  # å®‰å…¨ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ security_decorators.py  # å®‰å…¨è£…é¥°å™¨
â”‚   â”œâ”€â”€ ğŸ“„ admin_path.py           # åŠ¨æ€ç®¡ç†è·¯å¾„æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ membership_service.py   # ä¼šå‘˜æœåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ requirements.txt        # Python ä¾èµ–æ¸…å•
â”‚   â”œâ”€â”€ ğŸ“„ model_config.json       # æ¨¡å‹é…ç½®æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ routers/                # API è·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ auth.py             # è®¤è¯ç›¸å…³è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ keys.py             # å¯†é’¥ç®¡ç†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ admin.py            # ç®¡ç†åå°è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ totp.py             # TOTP è·¯ç”±
â”‚   â”‚   â””â”€â”€ ğŸ“„ payment.py          # æ”¯ä»˜å›è°ƒè·¯ç”±
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ sql/                    # SQL è„šæœ¬
â”‚       â”œâ”€â”€ ğŸ“„ create_tables.sql   # å»ºè¡¨è„šæœ¬
â”‚       â””â”€â”€ ğŸ“„ migrate_*.sql       # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚
â”œâ”€â”€ ğŸ“ css/                        # å‰ç«¯æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ ğŸ“„ style.css               # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ ğŸ“„ dashboard.css           # ä»ªè¡¨ç›˜æ ·å¼
â”‚   â”œâ”€â”€ ğŸ“„ admin.css               # ç®¡ç†åå°æ ·å¼
â”‚   â”œâ”€â”€ ğŸ“„ profile.css             # ä¸ªäººèµ„æ–™æ ·å¼
â”‚   â”œâ”€â”€ ğŸ“„ register.css            # æ³¨å†Œé¡µé¢æ ·å¼
â”‚   â””â”€â”€ ğŸ“„ terms.css               # æ¡æ¬¾é¡µé¢æ ·å¼
â”‚
â”œâ”€â”€ ğŸ“ js/                         # å‰ç«¯ JavaScript
â”‚   â”œâ”€â”€ ğŸ“„ script.js               # ç™»å½•é¡µé¢è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ dashboard.js            # ä»ªè¡¨ç›˜è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ admin.js                # ç®¡ç†åå°è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ“„ profile.js              # ä¸ªäººèµ„æ–™è„šæœ¬
â”‚   â””â”€â”€ ğŸ“„ register.js             # æ³¨å†Œé¡µé¢è„šæœ¬
â”‚
â”œâ”€â”€ ğŸ“ icons/                      # å›¾æ ‡èµ„æº
â”œâ”€â”€ ğŸ“ images/                     # å›¾ç‰‡èµ„æº
â”‚
â”œâ”€â”€ ğŸ“ sql/                        # æ ¹ç›®å½• SQL è„šæœ¬ï¼ˆDocker åˆå§‹åŒ–ï¼‰
â”‚
â”œâ”€â”€ ğŸ“„ index.html                  # ç™»å½•é¡µé¢
â”œâ”€â”€ ğŸ“„ dashboard.html              # ä¸»ä»ªè¡¨ç›˜
â”œâ”€â”€ ğŸ“„ admin.html                  # ç®¡ç†åå°é¡µé¢
â”œâ”€â”€ ğŸ“„ register.html               # æ³¨å†Œé¡µé¢
â”œâ”€â”€ ğŸ“„ profile.html                # ä¸ªäººèµ„æ–™é¡µé¢
â”œâ”€â”€ ğŸ“„ terms.html                  # æœåŠ¡æ¡æ¬¾é¡µé¢
â”‚
â”œâ”€â”€ ğŸ“„ Dockerfile                  # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ ğŸ“„ docker-compose.yml          # Docker Compose é…ç½®
â”œâ”€â”€ ğŸ“„ nginx.conf                  # Nginx é…ç½®
â”œâ”€â”€ ğŸ“„ start_all.py                # ä¸€é”®å¯åŠ¨è„šæœ¬
â””â”€â”€ ğŸ“„ README.md                   # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

### å…³é”®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶è·¯å¾„ | èŒè´£æè¿° |
|---------|---------|
| `backend/main.py` | FastAPI åº”ç”¨å…¥å£ï¼Œé…ç½®ä¸­é—´ä»¶ã€è·¯ç”±ã€ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ |
| `backend/config.py` | ç¯å¢ƒé…ç½®ç®¡ç†ï¼ŒåŒ…å«å®‰å…¨å¯†é’¥ã€æ•°æ®åº“è¿æ¥ç­‰æ•æ„Ÿé…ç½® |
| `backend/models.py` | å®šä¹‰ 6 ä¸ªæ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼šUserã€ApiProviderã€ApiModelã€UserApiKeyã€LogEntryã€TOTPConfig |
| `backend/routers/admin.py` | ç®¡ç†åå°æ‰€æœ‰ API ç«¯ç‚¹ï¼ŒåŒ…å«ç”¨æˆ·/æœåŠ¡å•†/æ¨¡å‹ç®¡ç†å’Œæ—¥å¿—å®¡è®¡ |
| `backend/security_middleware.py` | å®‰å…¨ä¸­é—´ä»¶ï¼Œå®ç°åŠ¨æ€ç®¡ç†è·¯å¾„éªŒè¯å’Œåå°å…¥å£ä¿æŠ¤ |
| `js/dashboard.js` | å‰ç«¯æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å¯†é’¥çš„ CRUD æ“ä½œå’Œ API äº¤äº’ |

---

## å‰åç«¯åˆ†ç¦»æ¶æ„è¯´æ˜

### æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨ç»å…¸çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯ä½œä¸ºé™æ€èµ„æºç”± Nginx æ‰˜ç®¡ï¼Œåç«¯ä½œä¸ºç‹¬ç«‹æœåŠ¡è¿è¡Œåœ¨ 8000 ç«¯å£ã€‚

```mermaid
graph LR
    subgraph "å¼€å‘ç¯å¢ƒ"
        DevFront[å‰ç«¯ :5500]
        DevBack[åç«¯ :8000]
    end
    
    subgraph "ç”Ÿäº§ç¯å¢ƒ"
        ProdNginx[Nginx :80]
        ProdFront[é™æ€æ–‡ä»¶]
        ProdBack[åç«¯æœåŠ¡ :8000]
    end
    
    DevFront -->|CORS| DevBack
    ProdNginx --> ProdFront
    ProdNginx -->|åå‘ä»£ç†| ProdBack
```

### API é€šä¿¡æœºåˆ¶

å‰ç«¯é€šè¿‡ `fetch` API ä¸åç«¯é€šä¿¡ï¼Œè®¤è¯ä½¿ç”¨ Bearer Token æ–¹å¼ï¼š

```javascript
// å‰ç«¯è¯·æ±‚ç¤ºä¾‹ (js/dashboard.js:112-118)
const API_BASE_URL = 'http://localhost:8000';

function getAuthHeaders() {
    const token = localStorage.getItem('token');
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
}
```

åç«¯ CORS é…ç½®ï¼ˆ`backend/main.py:28-35`ï¼‰ï¼š

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,  # ç”Ÿäº§ç¯å¢ƒä»ç¯å¢ƒå˜é‡è¯»å–
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### å‰ç«¯æ¶æ„ç‰¹ç‚¹

1. **æ— æ¡†æ¶è®¾è®¡**: ä½¿ç”¨åŸç”Ÿ JavaScriptï¼Œé™ä½æŠ€æœ¯å€ºåŠ¡
2. **æ¨¡å—åŒ–ç»„ç»‡**: æ¯ä¸ªé¡µé¢å¯¹åº”ç‹¬ç«‹çš„ JS å’Œ CSS æ–‡ä»¶
3. **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨ `localStorage` å­˜å‚¨ Token å’Œç”¨æˆ·ä¿¡æ¯
4. **å®‰å…¨è€ƒè™‘**: å‰ç«¯å®ç° XSS é˜²æŠ¤ï¼ˆHTML è½¬ä¹‰å‡½æ•°ï¼‰

```javascript
// XSS é˜²æŠ¤å®ç° (js/dashboard.js:9-14)
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
```

---

## é…ç½®ç®¡ç†æ–¹å¼

### ç¯å¢ƒé…ç½®ç±»è®¾è®¡

é¡¹ç›®ä½¿ç”¨ Python ç±»å®ç°é…ç½®ç®¡ç†ï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚åŒ–é…ç½®ï¼š

```python
# backend/config.py
class Settings:
    # ç¯å¢ƒè¯†åˆ«
    ENV: str = os.getenv("ENV", "development")
    DEBUG: bool = ENV == "development"
    
    # æ•°æ®åº“é…ç½®
    _database_url = os.getenv("DATABASE_URL")
    if not _database_url:
        if ENV == "production":
            raise ValueError("DATABASE_URL environment variable is required in production")
        _database_url = "postgresql://postgres:123456@localhost:5432/llm_api_manager"
    DATABASE_URL: str = _database_url
    
    # å®‰å…¨é…ç½®
    SECRET_KEY: str = os.getenv("SECRET_KEY")
    if not SECRET_KEY:
        if ENV == "production":
            raise ValueError("SECRET_KEY environment variable is required in production")
        SECRET_KEY = secrets.token_urlsafe(32)  # å¼€å‘ç¯å¢ƒè‡ªåŠ¨ç”Ÿæˆ
        logger.warning("âš ï¸  ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ SECRET_KEYï¼ˆä»…é™å¼€å‘ç¯å¢ƒï¼‰")
```

### é…ç½®é¡¹æ¸…å•

| é…ç½®é¡¹ | ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|---------|-------|------|
| `ENV` | ENV | development | è¿è¡Œç¯å¢ƒ |
| `DATABASE_URL` | DATABASE_URL | - | æ•°æ®åº“è¿æ¥ä¸² |
| `SECRET_KEY` | SECRET_KEY | è‡ªåŠ¨ç”Ÿæˆ | JWT ç­¾åå¯†é’¥ |
| `ENCRYPTION_KEY` | ENCRYPTION_KEY | è‡ªåŠ¨ç”Ÿæˆ | API å¯†é’¥åŠ å¯†å¯†é’¥ |
| `ENCRYPTION_SALT` | ENCRYPTION_SALT | dev-salt-16-byte | åŠ å¯†ç›å€¼ |
| `CORS_ORIGINS` | CORS_ORIGINS | ["*"] | CORS å…è®¸åŸŸå |
| `RATE_LIMIT_PER_MINUTE` | RATE_LIMIT_PER_MINUTE | 60 | æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶ |
| `MODEL_CONFIG_URL` | MODEL_CONFIG_URL | - | è¿œç¨‹æ¨¡å‹é…ç½® URL |

### ç”Ÿäº§ç¯å¢ƒéªŒè¯

é…ç½®ç±»åŒ…å«ç”Ÿäº§ç¯å¢ƒå®‰å…¨éªŒè¯æ–¹æ³•ï¼š

```python
def validate_production(self):
    """å¯åŠ¨æ—¶éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    if self.ENV == "production":
        issues = []
        
        if len(self.SECRET_KEY) < 32:
            issues.append("SECRET_KEY é•¿åº¦ä¸è¶³ 32 å­—ç¬¦")
        
        if len(self.API_KEY_ENCRYPTION_KEY) < 32:
            issues.append("ENCRYPTION_KEY é•¿åº¦ä¸è¶³ 32 å­—èŠ‚")
        
        if "*" in self.CORS_ORIGINS:
            issues.append("CORS_ORIGINS åŒ…å«é€šé…ç¬¦ '*'")
        
        if issues:
            raise ValueError(f"Production security issues: {', '.join(issues)}")
```

---

## å®‰å…¨æ€§è®¾è®¡è¯¦è§£

### 1. è®¤è¯ä¸æˆæƒæœºåˆ¶

#### JWT Token è®¤è¯

ç³»ç»Ÿä½¿ç”¨ JWT (JSON Web Token) å®ç°æ— çŠ¶æ€è®¤è¯ï¼š

```python
# backend/auth.py:18-26
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
    return encoded_jwt
```

**Token æœ‰æ•ˆæœŸ**: 24 å°æ—¶ï¼ˆ`ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24`ï¼‰

#### å¯†ç å®‰å…¨

ä½¿ç”¨ bcrypt ç®—æ³•è¿›è¡Œå¯†ç å“ˆå¸Œï¼Œç¡®ä¿å³ä½¿æ•°æ®åº“æ³„éœ²ä¹Ÿæ— æ³•è¿˜åŸæ˜æ–‡å¯†ç ï¼š

```python
# backend/auth.py:13-16
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)
```

#### è§’è‰²æƒé™æ§åˆ¶

ç³»ç»Ÿå®šä¹‰äº†ä¸¤ç§ç”¨æˆ·è§’è‰²ï¼š`user` å’Œ `admin`ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥å®ç°æƒé™éªŒè¯ï¼š

```python
# backend/auth.py:53-62
def get_current_admin_user(current_user: User = Depends(get_current_user)) -> User:
    """éªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜"""
    if current_user.role != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Admin privileges required"
        )
    return current_user
```

### 2. æ•°æ®åŠ å¯†

#### API å¯†é’¥åŠ å¯†å­˜å‚¨

ç”¨æˆ·çš„ API å¯†é’¥ä½¿ç”¨ Fernet (AES-128) å¯¹ç§°åŠ å¯†å­˜å‚¨ï¼Œå¯†é’¥é€šè¿‡ PBKDF2 æ´¾ç”Ÿï¼š

```python
# backend/routers/keys.py:22-28
def get_encryption_key() -> bytes:
    kdf = PBKDF2HMAC(
        algorithm=hashes.SHA256(),
        length=32,
        salt=settings.ENCRYPTION_SALT,
        iterations=100000,
    )
    return urlsafe_b64encode(kdf.derive(settings.API_KEY_ENCRYPTION_KEY))

def encrypt_api_key(api_key: str) -> str:
    f = Fernet(get_encryption_key())
    return f.encrypt(api_key.encode()).decode()
```

**åŠ å¯†å‚æ•°**:
- ç®—æ³•: AES-128 (Fernet)
- å¯†é’¥æ´¾ç”Ÿ: PBKDF2-HMAC-SHA256
- è¿­ä»£æ¬¡æ•°: 100,000 æ¬¡
- ç›å€¼é•¿åº¦: 16 å­—èŠ‚

### 3. è¯·æ±‚é™æµ

ä½¿ç”¨ `slowapi` åº“å®ç°åŸºäº IP çš„è¯·æ±‚é™æµï¼Œé˜²æ­¢æš´åŠ›ç ´è§£å’Œ DDoS æ”»å‡»ï¼š

```python
# backend/main.py:17-19
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
```

**é™æµè§„åˆ™**:

| ç«¯ç‚¹ | é™åˆ¶ | è¯´æ˜ |
|------|-----|------|
| `/api/captcha` | 10/åˆ†é’Ÿ | éªŒè¯ç è·å– |
| `/api/register` | 5/å°æ—¶ | ç”¨æˆ·æ³¨å†Œ |
| `/api/login` | 10/åˆ†é’Ÿ | ç”¨æˆ·ç™»å½• |
| ç®¡ç†å‘˜é…ç½®åŒæ­¥ | 5/åˆ†é’Ÿ | æ¨¡å‹é…ç½®æ“ä½œ |

```python
# backend/routers/auth.py:44-45
@router.get("/captcha", response_model=CaptchaResponse)
@limiter.limit("10/minute")  # æ¯åˆ†é’Ÿæœ€å¤šè·å– 10 æ¬¡éªŒè¯ç 
def get_captcha(request: Request):
    ...
```

### 4. è´¦æˆ·é”å®šæœºåˆ¶

è¿ç»­ç™»å½•å¤±è´¥ 5 æ¬¡åï¼Œè´¦æˆ·å°†è¢«é”å®š 30 åˆ†é’Ÿï¼š

```python
# backend/routers/auth.py:85-98
if not verify_password(user_data.password, user.password_hash):
    # Increment login attempts
    user.login_attempts = (user.login_attempts or 0) + 1
    
    # Lock account after 5 failed attempts for 30 minutes
    if user.login_attempts >= 5:
        user.locked_until = datetime.utcnow() + timedelta(minutes=30)
        db.commit()
        raise HTTPException(status_code=400, detail="Account locked for 30 minutes due to too many failed attempts")
    
    db.commit()
    raise HTTPException(...)
```

### 5. åŠ¨æ€ç®¡ç†è·¯å¾„

ç®¡ç†åå°é‡‡ç”¨åŠ¨æ€è·¯å¾„è®¾è®¡ï¼Œæ¯æ¬¡æœåŠ¡å¯åŠ¨æ—¶ç”Ÿæˆéšæœºè·¯å¾„ï¼Œé˜²æ­¢æš´åŠ›çŒœæµ‹ï¼š

```python
# backend/admin_path.py
ADMIN_PATH_LENGTH = 16

def generate_secure_path(length: int = ADMIN_PATH_LENGTH) -> str:
    """ç”Ÿæˆå®‰å…¨çš„éšæœºè·¯å¾„"""
    chars = string.ascii_lowercase + string.digits
    chars = chars.replace('l', '').replace('1', '').replace('o', '').replace('0', '')
    return ''.join(secrets.choice(chars) for _ in range(length))
```

**å®‰å…¨ç­–ç•¥**:
- è·¯å¾„é•¿åº¦: 16 ä½éšæœºå­—ç¬¦
- æ’é™¤æ˜“æ··æ·†å­—ç¬¦ (l, 1, o, 0)
- æ¯æ¬¡æœåŠ¡é‡å¯é‡æ–°ç”Ÿæˆ
- åªæœ‰éªŒè¯é€šè¿‡çš„ç®¡ç†å‘˜æ‰èƒ½è·å–å®Œæ•´è·¯å¾„

### 6. é«˜å±æ“ä½œäºŒæ¬¡ç¡®è®¤

å®šä¹‰é«˜å±æ“ä½œåˆ—è¡¨ï¼Œéœ€è¦å®¢æˆ·ç«¯å‘é€ç¡®è®¤å¤´æ‰èƒ½æ‰§è¡Œï¼š

```python
# backend/security_decorators.py
HIGH_RISK_OPERATIONS = [
    'åˆ é™¤ç”¨æˆ·',
    'åˆ é™¤å¯†é’¥',
    'ç¦ç”¨ç”¨æˆ·',
    'ä¿®æ”¹ç”¨æˆ·è§’è‰²',
    'åˆ é™¤æœåŠ¡å•†',
    'åˆ é™¤æ¨¡å‹',
    'æ¸…ç©ºé…ç½®'
]

def require_confirm(action: str):
    """é«˜å±æ“ä½œäºŒæ¬¡ç¡®è®¤è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        async def async_wrapper(*args, **kwargs):
            if action in HIGH_RISK_OPERATIONS:
                confirm_header = request.headers.get('X-Confirm-Action')
                if not confirm_header or confirm_header.lower() != 'true':
                    raise HTTPException(
                        status_code=status.HTTP_403_FORBIDDEN,
                        detail=f"æ­¤æ“ä½œä¸ºé«˜å±æ“ä½œï¼Œè¯·å…ˆç¡®è®¤: {action}"
                    )
            return await func(*args, **kwargs)
        return async_wrapper
    return decorator
```

### 7. å®‰å…¨å“åº”å¤´

æ‰€æœ‰ HTTP å“åº”è‡ªåŠ¨æ·»åŠ å®‰å…¨å¤´ï¼š

```python
# backend/main.py:75-90
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    
    # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    response.headers["X-Frame-Options"] = "DENY"
    # é˜²æ­¢ MIME ç±»å‹å—…æ¢
    response.headers["X-Content-Type-Options"] = "nosniff"
    # XSS é˜²æŠ¤
    response.headers["X-XSS-Protection"] = "1; mode=block"
    # å¼•ç”¨ç­–ç•¥
    response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
    # ç¦æ­¢æœç´¢å¼•æ“ç´¢å¼•
    response.headers["X-Robots-Tag"] = "noindex, nofollow"
    
    return response
```

### 8. éªŒè¯ç ä¿æŠ¤

ç”Ÿäº§ç¯å¢ƒå¯ç”¨å›¾å½¢éªŒè¯ç ï¼Œé˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»ï¼š

```python
# backend/captcha.py
CAPTCHA_EXPIRE_SECONDS = 300  # 5åˆ†é’Ÿæœ‰æ•ˆæœŸ

def generate_captcha_image(text: str) -> bytes:
    """ç”ŸæˆéªŒè¯ç å›¾ç‰‡"""
    # åŒ…å«å¹²æ‰°çº¿å’Œå¹²æ‰°ç‚¹
    # éšæœºé¢œè‰²å’Œä½ç½®
    # Base64 ç¼–ç è¿”å›
```

### 9. TOTP åŒå› ç´ è®¤è¯

æ”¯æŒç”¨æˆ·å¯ç”¨ TOTP åŒå› ç´ è®¤è¯ï¼š

```python
# backend/totp_utils.py
def verify_totp_code(secret: str, token: str):
    """éªŒè¯ TOTP ä»¤ç‰Œ"""
    totp = pyotp.TOTP(secret)
    # å…è®¸ 1 ä¸ªæ—¶é—´çª—å£çš„åå·®ï¼ˆ30ç§’ï¼‰
    return totp.verify(token, valid_window=1)
```

---

## éƒ¨ç½²æ¶æ„å’Œ Docker é…ç½®

### Docker Compose æ¶æ„

```mermaid
graph TB
    subgraph "Docker Compose ç¯å¢ƒ"
        subgraph "Frontend Container"
            NginxContainer[Nginx Alpine<br/>:80]
            StaticVol[é™æ€æ–‡ä»¶å·]
        end
        
        subgraph "Backend Container"
            PythonContainer[Python 3.13 Slim<br/>:8000]
            BackendCode[åç«¯ä»£ç ]
        end
        
        subgraph "Database Container"
            PostgresContainer[PostgreSQL 15 Alpine<br/>:5432]
            PostgresVol[postgres_data å·]
        end
    end
    
    User[ç”¨æˆ·è¯·æ±‚] --> NginxContainer
    NginxContainer --> StaticVol
    NginxContainer -->|API ä»£ç†| PythonContainer
    PythonContainer --> PostgresContainer
    PostgresContainer --> PostgresVol
```

### docker-compose.yml é…ç½®è¯¦è§£

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“æœåŠ¡
  db:
    image: postgres:15-alpine
    container_name: api-key-manager-db
    environment:
      POSTGRES_DB: llm_api_manager
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/create_tables.sql:/docker-entrypoint-initdb.d/01-create_tables.sql
      - ./sql/migrate_add_category.sql:/docker-entrypoint-initdb.d/02-migrate_category.sql
      - ./sql/migrate_add_custom_provider.sql:/docker-entrypoint-initdb.d/03-migrate_provider.sql
      - ./sql/migrate_add_user_role.sql:/docker-entrypoint-initdb.d/04-migrate_role.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # åç«¯ API æœåŠ¡
  backend:
    build: .
    container_name: api-key-manager-backend
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/llm_api_manager
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-change-this-encryption-key-in-production}
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # å‰ç«¯ Nginx æœåŠ¡
  frontend:
    image: nginx:alpine
    container_name: api-key-manager-frontend
    volumes:
      - ./:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
```

### Dockerfile åˆ†æ

```dockerfile
# Dockerfile
FROM python:3.13-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY backend/ ./backend/
COPY sql/ ./sql/

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV DATABASE_URL=postgresql://postgres:postgres@db:5432/llm_api_manager

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
WORKDIR /app/backend
CMD ["python", "run_server.py"]
```

### Nginx åå‘ä»£ç†é…ç½®

```nginx
# nginx.conf
server {
    listen 80;
    server_name localhost;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # åç«¯ API ä»£ç†
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ç¦ç”¨ç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    add_header Cache-Control "no-store, no-cache, must-revalidate";
}
```

---

## æ•°æ®æ¨¡å‹è®¾è®¡

### ER å›¾

```mermaid
erDiagram
    users ||--o{ user_api_keys : "æ‹¥æœ‰"
    users ||--o| totp_configs : "é…ç½®"
    users ||--o{ log_entries : "äº§ç”Ÿ"
    api_providers ||--o{ api_models : "æä¾›"
    api_providers ||--o{ user_api_keys : "å…³è”"
    
    users {
        int id PK
        string username UK
        string email UK
        string password_hash
        string salt
        string role
        string membership_tier
        timestamp membership_expire_at
        timestamp created_at
        timestamp updated_at
        timestamp last_login
        boolean is_active
        int login_attempts
        timestamp locked_until
    }
    
    api_providers {
        int id PK
        string name UK
        string display_name
        string base_url
        text description
        string icon
        boolean is_active
        boolean is_custom
        int created_by FK
        int sort_order
        timestamp created_at
    }
    
    api_models {
        int id PK
        int provider_id FK
        string model_id
        string model_name
        string category
        string context_window
        boolean is_default
        int sort_order
    }
    
    user_api_keys {
        int id PK
        int user_id FK
        int provider_id FK
        string key_name
        text api_key_encrypted
        string api_key_preview
        string model_id
        string status
        text notes
        timestamp created_at
        timestamp updated_at
        timestamp last_used_at
    }
    
    totp_configs {
        int id PK
        int user_id FK "UK"
        string secret
        boolean is_enabled
        timestamp created_at
    }
    
    log_entries {
        int id PK
        int user_id FK
        string username
        string action
        string resource_type
        int resource_id
        string resource_name
        string ip_address
        text user_agent
        string status
        text error_message
        text details
        timestamp created_at
    }
```

### æ¨¡å‹è¯¦ç»†å®šä¹‰

#### User æ¨¡å‹

```python
# backend/models.py:9-33
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=False)
    salt = Column(String(64))
    role = Column(String(20), default="user")  # "admin" or "user"
    
    # ä¼šå‘˜ç³»ç»Ÿ
    membership_tier = Column(String(20), default="free")  # free, basic, pro
    membership_expire_at = Column(TIMESTAMP, nullable=True)
    membership_started_at = Column(TIMESTAMP, nullable=True)
    
    # æ—¶é—´æˆ³
    created_at = Column(TIMESTAMP, default=datetime.utcnow)
    updated_at = Column(TIMESTAMP, default=datetime.utcnow, onupdate=datetime.utcnow)
    last_login = Column(TIMESTAMP, nullable=True)
    
    # è´¦æˆ·çŠ¶æ€
    is_active = Column(Boolean, default=True)
    login_attempts = Column(Integer, default=0)
    locked_until = Column(TIMESTAMP, nullable=True)
    
    # å…³è”å…³ç³»
    api_keys = relationship("UserApiKey", back_populates="user", cascade="all, delete-orphan")
    totp_config = relationship("TOTPConfig", back_populates="user", cascade="all, delete-orphan", uselist=False)
```

#### ApiProvider æ¨¡å‹

```python
class ApiProvider(Base):
    __tablename__ = "api_providers"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, nullable=False)
    display_name = Column(String(100))
    base_url = Column(String(255), nullable=False)
    description = Column(Text)
    icon = Column(String(100))
    is_active = Column(Boolean, default=True)
    is_custom = Column(Boolean, default=False)  # ç”¨æˆ·è‡ªå®šä¹‰æœåŠ¡å•†æ ‡è¯†
    created_by = Column(Integer, ForeignKey("users.id"), nullable=True)
    sort_order = Column(Integer, default=0)
```

#### UserApiKey æ¨¡å‹

```python
class UserApiKey(Base):
    __tablename__ = "user_api_keys"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    provider_id = Column(Integer, ForeignKey("api_providers.id", ondelete="SET NULL"), nullable=True)
    key_name = Column(String(100), nullable=False)
    api_key_encrypted = Column(Text, nullable=False)  # åŠ å¯†å­˜å‚¨
    api_key_preview = Column(String(20))  # å¯†é’¥é¢„è§ˆ
    model_id = Column(String(100), nullable=True)
    status = Column(String(20), default="active")
    notes = Column(Text)
    created_at = Column(TIMESTAMP, default=datetime.utcnow)
    last_used_at = Column(TIMESTAMP, nullable=True)
```

### æ•°æ®åº“ç´¢å¼•è®¾è®¡

```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- å¯†é’¥è¡¨ç´¢å¼•
CREATE INDEX idx_user_api_keys_user_id ON user_api_keys(user_id);
CREATE INDEX idx_user_api_keys_provider_id ON user_api_keys(provider_id);
CREATE INDEX idx_user_api_keys_status ON user_api_keys(status);

-- æ—¥å¿—è¡¨ç´¢å¼•
CREATE INDEX idx_log_entries_user_id ON log_entries(user_id);
CREATE INDEX idx_log_entries_action ON log_entries(action);
CREATE INDEX idx_log_entries_created_at ON log_entries(created_at);

-- æ¨¡å‹åˆ†ç±»ç´¢å¼•
CREATE INDEX idx_api_models_category ON api_models(category);
```

---

## æ½œåœ¨é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

#### 1. å¯†é’¥åŠ å¯†è¿­ä»£æ¬¡æ•°è¾ƒä½

**é—®é¢˜æè¿°**: å½“å‰ PBKDF2 è¿­ä»£æ¬¡æ•°ä¸º 100,000 æ¬¡ï¼Œè™½ç„¶ç¬¦åˆæœ€ä½å®‰å…¨æ ‡å‡†ï¼Œä½†éšç€ç¡¬ä»¶æ€§èƒ½æå‡ï¼Œå»ºè®®æé«˜åˆ°è‡³å°‘ 310,000 æ¬¡ï¼ˆOWASP 2023 æ¨èï¼‰ã€‚

**å½“å‰ä»£ç ** (`backend/routers/keys.py:22-28`):
```python
kdf = PBKDF2HMAC(
    algorithm=hashes.SHA256(),
    length=32,
    salt=settings.ENCRYPTION_SALT,
    iterations=100000,  # å»ºè®®æå‡åˆ° 310000
)
```

**æ”¹è¿›å»ºè®®**:
```python
iterations = int(os.getenv("PBKDF2_ITERATIONS", "310000"))
```

#### 2. JWT æ— çŠ¶æ€å¸¦æ¥çš„ä¼šè¯ç®¡ç†é—®é¢˜

**é—®é¢˜æè¿°**: JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œæ— æ³•å®ç°çœŸæ­£çš„"ç™»å‡º"åŠŸèƒ½ï¼ŒToken åœ¨è¿‡æœŸå‰å§‹ç»ˆæœ‰æ•ˆã€‚

**å½“å‰å®ç°** (`backend/routers/auth.py:125-128`):
```python
@router.post("/logout", response_model=MessageResponse)
def logout(current_user: User = Depends(get_current_user)):
    # In a stateless JWT system, logout is handled client-side
    # Could implement token blacklist here if needed
    return MessageResponse(message="Logged out successfully", success=True)
```

**æ”¹è¿›å»ºè®®**:
- ä½¿ç”¨ Redis å®ç° Token é»‘åå•
- æˆ–è€…æ”¹ç”¨çŸ­æœ‰æ•ˆæœŸ Token + Refresh Token æœºåˆ¶

#### 3. æ—¥å¿—ä¸­é—´ä»¶å­˜åœ¨å¼‚å¸¸å¤„ç†é£é™©

**é—®é¢˜æè¿°**: æ—¥å¿—ä¸­é—´ä»¶åœ¨è·å–ç”¨æˆ·ä¿¡æ¯æ—¶ä½¿ç”¨äº†ç©ºçš„ `except` å—ï¼Œå¯èƒ½éšè—é”™è¯¯ã€‚

**å½“å‰ä»£ç ** (`backend/log_middleware.py:45-47`):
```python
try:
    current_user = await get_current_user(request)
except:
    pass  # åæ‰æ‰€æœ‰å¼‚å¸¸
```

**æ”¹è¿›å»ºè®®**:
```python
except HTTPException:
    pass  # åªå¿½ç•¥é¢„æœŸçš„è®¤è¯å¼‚å¸¸
except Exception as e:
    logger.warning(f"Unexpected error in log middleware: {e}")
```

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

#### 4. ç”Ÿäº§ç¯å¢ƒ API æ–‡æ¡£å®Œå…¨å…³é—­

**é—®é¢˜æè¿°**: ç”Ÿäº§ç¯å¢ƒå®Œå…¨å…³é—­ Swagger æ–‡æ¡£å¯èƒ½å½±å“ API è°ƒè¯•ã€‚

**å½“å‰ä»£ç ** (`backend/main.py:21-22`):
```python
docs_url="/docs" if settings.DEBUG else None,
redoc_url="/redoc" if settings.DEBUG else None
```

**æ”¹è¿›å»ºè®®**:
- å¯ä»¥ä¸ºç®¡ç†å‘˜å¼€æ”¾æ–‡æ¡£è®¿é—®
- æˆ–è€…ä½¿ç”¨ HTTP Basic Auth ä¿æŠ¤æ–‡æ¡£ç«¯ç‚¹

#### 5. é‚®ä»¶æœåŠ¡æœªå®ç°

**é—®é¢˜æè¿°**: ä¼šå‘˜åˆ°æœŸæé†’çš„é‚®ä»¶æœåŠ¡ä»…ä¸ºå ä½ç¬¦ï¼Œæœªå®é™…å®ç°ã€‚

**å½“å‰ä»£ç ** (`backend/membership_service.py:80-99`):
```python
def _send_email(self, email: str, days_left: int, expire_at: datetime):
    """å‘é€é‚®ä»¶æé†’"""
    # TODO: å®ç°é‚®ä»¶å‘é€
    pass
```

**æ”¹è¿›å»ºè®®**:
- é›†æˆ SendGridã€é˜¿é‡Œäº‘é‚®ä»¶æ¨é€ç­‰æœåŠ¡
- æˆ–è€…ä½¿ç”¨ SMTP æœåŠ¡å™¨

#### 6. ç¼ºå°‘æ•°æ®åº“è¿æ¥æ± é…ç½®

**é—®é¢˜æè¿°**: SQLAlchemy é»˜è®¤è¿æ¥æ± é…ç½®å¯èƒ½ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚

**å½“å‰ä»£ç ** (`backend/database.py:8-9`):
```python
engine = create_engine(DATABASE_URL)  # ä½¿ç”¨é»˜è®¤æ± é…ç½®
```

**æ”¹è¿›å»ºè®®**:
```python
engine = create_engine(
    DATABASE_URL,
    pool_size=10,
    max_overflow=20,
    pool_pre_ping=True,
    pool_recycle=3600
)
```

### ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

#### 7. å‰ç«¯ç¼ºå°‘æ„å»ºå·¥å…·

**é—®é¢˜æè¿°**: å‰ç«¯ä½¿ç”¨åŸç”Ÿ JavaScriptï¼Œç¼ºå°‘æ¨¡å—æ‰“åŒ…å’Œä»£ç å‹ç¼©ã€‚

**æ”¹è¿›å»ºè®®**:
- å¼•å…¥ Vite æˆ– Webpack è¿›è¡Œæ‰“åŒ…
- å®ç°ä»£ç åˆ†å‰²å’ŒæŒ‰éœ€åŠ è½½

#### 8. ç¼ºå°‘ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**é—®é¢˜æè¿°**: ç³»ç»Ÿæ²¡æœ‰é›†æˆç›‘æ§æŒ‡æ ‡é‡‡é›†å’Œå‘Šè­¦é€šçŸ¥ã€‚

**æ”¹è¿›å»ºè®®**:
- é›†æˆ Prometheus æŒ‡æ ‡é‡‡é›†
- é…ç½® Grafana å¯è§†åŒ–ä»ªè¡¨ç›˜
- è®¾ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦

#### 9. ç¼ºå°‘ API ç‰ˆæœ¬ç®¡ç†

**é—®é¢˜æè¿°**: API è·¯å¾„æ²¡æœ‰ç‰ˆæœ¬å·ï¼Œæœªæ¥å‡çº§å¯èƒ½é€ æˆå…¼å®¹æ€§é—®é¢˜ã€‚

**æ”¹è¿›å»ºè®®**:
```python
app.include_router(auth.router, prefix="/api/v1")
app.include_router(keys.router, prefix="/api/v1/keys")
```

---

## ä¾èµ–æ¸…å•

### Python åç«¯ä¾èµ–

| ä¾èµ–åŒ… | ç‰ˆæœ¬ | ç”¨é€” |
|-------|------|------|
| fastapi | 0.115.0 | Web æ¡†æ¶ |
| uvicorn[standard] | 0.32.0 | ASGI æœåŠ¡å™¨ |
| psycopg[binary] | 3.2.3 | PostgreSQL é©±åŠ¨ |
| sqlalchemy | 2.0.35 | ORM æ¡†æ¶ |
| pydantic[email] | 2.9.2 | æ•°æ®éªŒè¯ |
| python-jose[cryptography] | 3.3.0 | JWT å¤„ç† |
| passlib[bcrypt] | 1.7.4 | å¯†ç å“ˆå¸Œ |
| python-multipart | 0.0.12 | è¡¨å•è§£æ |
| cryptography | 43.0.3 | åŠ å¯†å·¥å…· |
| httpx | 0.27.2 | HTTP å®¢æˆ·ç«¯ |
| slowapi | 0.1.9 | é™æµåº“ |
| pillow | 11.0.0 | å›¾åƒå¤„ç†ï¼ˆéªŒè¯ç ï¼‰ |
| apscheduler | 3.10.4 | å®šæ—¶ä»»åŠ¡è°ƒåº¦ |

### å‰ç«¯ä¾èµ–

| ä¾èµ– | è¯´æ˜ |
|------|------|
| Lucide Icons | å›¾æ ‡åº“ |
| Font Awesome | å›¾æ ‡åº“ï¼ˆéƒ¨åˆ†é¡µé¢ï¼‰ |

### Docker é•œåƒä¾èµ–

| é•œåƒ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| python | 3.13-slim | åç«¯è¿è¡Œç¯å¢ƒ |
| postgres | 15-alpine | æ•°æ®åº“ |
| nginx | alpine | åå‘ä»£ç† |

---

## æ€»ç»“å’Œè¯„åˆ†

### æ¶æ„è¯„åˆ†çŸ©é˜µ

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **ä»£ç ç»„ç»‡** | â­â­â­â­â˜† | æ¨¡å—åˆ’åˆ†æ¸…æ™°ï¼Œè·¯ç”±åˆ†ç¦»åˆç† |
| **å®‰å…¨æ€§** | â­â­â­â­â­ | å¤šå±‚æ¬¡å®‰å…¨è®¾è®¡ï¼ŒåŠ å¯†/è®¤è¯/ï¿½ï¿½ï¿½æµå®Œå¤‡ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â˜† | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå……åˆ† |
| **å¯æ‰©å±•æ€§** | â­â­â­â˜†â˜† | ç¼ºå°‘æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜å±‚ç­‰æ‰©å±•æœºåˆ¶ |
| **æ€§èƒ½ä¼˜åŒ–** | â­â­â­â˜†â˜† | ç¼ºå°‘ç¼“å­˜ã€è¿æ¥æ± ä¼˜åŒ– |
| **æ–‡æ¡£å®Œæ•´æ€§** | â­â­â­â­â˜† | README è¯¦ç»†ï¼Œä½†ç¼ºå°‘ API æ–‡æ¡£ |
| **æµ‹è¯•è¦†ç›–** | â­â­â˜†â˜†â˜† | ç¼ºå°‘å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |
| **ç›‘æ§è¿ç»´** | â­â­â˜†â˜†â˜† | ç¼ºå°‘ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦ |

### ç»¼åˆè¯„åˆ†: â­â­â­â­â˜† (4.0/5.0)

### äº®ç‚¹æ€»ç»“

1. **ä¼ä¸šçº§å®‰å…¨è®¾è®¡**: åŠ¨æ€ç®¡ç†è·¯å¾„ã€é«˜å±æ“ä½œäºŒæ¬¡ç¡®è®¤ã€å¤šå±‚æ¬¡é˜²æŠ¤
2. **å¯†é’¥å®‰å…¨å­˜å‚¨**: PBKDF2 + Fernet åŠ å¯†ï¼Œå¯†é’¥é¢„è§ˆæœºåˆ¶
3. **çµæ´»çš„æœåŠ¡å•†æ‰©å±•**: æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æœåŠ¡å•†
4. **å®Œå–„çš„ä¼šå‘˜ç³»ç»Ÿ**: è‡ªåŠ¨é™çº§ã€åˆ°æœŸæé†’
5. **æ¸…æ™°çš„ä»£ç æ¶æ„**: æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»

### æ”¹è¿›è·¯çº¿å›¾

```
çŸ­æœŸ (1-2 å‘¨)
â”œâ”€â”€ æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–
â”œâ”€â”€ å®ç°é‚®ä»¶é€šçŸ¥æœåŠ¡
â””â”€â”€ ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®

ä¸­æœŸ (1-2 æœˆ)
â”œâ”€â”€ å¼•å…¥ Redis å®ç° Token é»‘åå•
â”œâ”€â”€ æ·»åŠ  Prometheus ç›‘æ§æŒ‡æ ‡
â”œâ”€â”€ å®ç° API ç‰ˆæœ¬ç®¡ç†
â””â”€â”€ å‰ç«¯å¼•å…¥æ„å»ºå·¥å…·

é•¿æœŸ (3-6 æœˆ)
â”œâ”€â”€ å¾®æœåŠ¡æ‹†åˆ†ï¼ˆæ”¯ä»˜æœåŠ¡ç‹¬ç«‹ï¼‰
â”œâ”€â”€ å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡
â”œâ”€â”€ å®ç°å¤šç§Ÿæˆ·æ¶æ„
â””â”€â”€ å®Œå–„å›½é™…åŒ–æ”¯æŒ
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026å¹´2æœˆ18æ—¥  
**åˆ†æå·¥å…·ç‰ˆæœ¬**: iFlow CLI Architecture Analyzer v1.0  
**æ–‡æ¡£ä¿®è®¢**: æ— 