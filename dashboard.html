<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API密钥管理 - 控制台</title>
    <link rel="stylesheet" href="css/style.css?v=20260218">
    <link rel="stylesheet" href="css/dashboard.css?v=20260218">
    <style>
        /* 根据初始页面状态控制显示，避免闪烁 */
        html[data-initial-page="usage"] #keyManagePage { display: none !important; }
        html[data-initial-page="usage"] #usagePage { display: block !important; }
        html[data-initial-page="keys"] #keyManagePage { display: block !important; }
        html[data-initial-page="keys"] #usagePage { display: none !important; }
        html[data-initial-page="logs"] #keyManagePage { display: none !important; }
        html[data-initial-page="logs"] #logsPage { display: block !important; }
        html[data-initial-page="security"] #keyManagePage { display: none !important; }
        html[data-initial-page="security"] #securityPage { display: block !important; }
    </style>
    <script src="https://registry.npmmirror.com/lucide/latest/files/dist/umd/lucide.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- 内联脚本：在渲染内容前设置页面初始状态，避免闪烁 -->
    <script>
        (function() {
            var params = new URLSearchParams(window.location.search);
            var page = params.get('page');
            var validPages = ['usage', 'logs', 'security'];
            if (validPages.includes(page)) {
                document.documentElement.setAttribute('data-initial-page', page);
            } else {
                document.documentElement.setAttribute('data-initial-page', 'keys');
            }
        })();
    </script>
    <div class="app-layout">
        <!-- 左侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon-only">
                    <i data-lucide="shield-check"></i>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" id="navKeyManage" onclick="switchToKeyManage()">
                    <i data-lucide="key"></i>
                    <span>密钥管理</span>
                </a>
                <a href="#" class="nav-item" id="navUsage" onclick="switchToUsage()">
                    <i data-lucide="bar-chart-2"></i>
                    <span>使用统计</span>
                </a>
                <a href="#" class="nav-item" id="navLogs" onclick="switchToLogs()">
                    <i data-lucide="file-text"></i>
                    <span>操作日志</span>
                </a>
                <a href="#" class="nav-item" id="navSecurity" onclick="switchToSecurity()">
                    <i data-lucide="shield"></i>
                    <span>安全中心</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="profile.html" class="user-card" title="个人中心">
                    <div class="user-avatar">
                        <i data-lucide="user"></i>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="usernameDisplay">...</span>
                        <span class="user-role" id="userRoleDisplay">用户</span>
                    </div>
                    <i data-lucide="chevron-right" class="user-arrow"></i>
                </a>
                <button class="logout-btn" onclick="handleLogout()">
                    <i data-lucide="log-out"></i>
                    <span>退出登录</span>
                </button>
            </div>
        </aside>

        <!-- 右侧主内容区 -->
        <main class="main-area">
            <!-- 顶部栏 -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="breadcrumb">
                        <span>控制台</span>
                        <i data-lucide="chevron-right"></i>
                        <span id="currentPageName">密钥管理</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" id="refreshBtn" title="刷新" onclick="refreshData()">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
            </header>

            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 密钥管理页面 -->
                <div id="keyManagePage">
                <!-- 页面标题区 -->
                <div class="page-title">
                    <div class="title-info">
                        <h1>API密钥管理</h1>
                        <p>集中管理您的所有API密钥，安全便捷</p>
                    </div>
                    <button class="primary-btn" onclick="openAddModal()">
                        <i data-lucide="plus"></i>
                        <span>添加密钥</span>
                    </button>
                </div>

                <!-- 统计卡片行 -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="totalKeys">0</div>
                            <div class="stat-label">总密钥数</div>
                        </div>
                        <div class="stat-icon blue">
                            <i data-lucide="key"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="activeKeys">0</div>
                            <div class="stat-label">活跃密钥</div>
                        </div>
                        <div class="stat-icon green">
                            <i data-lucide="check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="totalProviders">0</div>
                            <div class="stat-label">服务商</div>
                        </div>
                        <div class="stat-icon purple">
                            <i data-lucide="server"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="expiredKeys">0</div>
                            <div class="stat-label">已过期</div>
                        </div>
                        <div class="stat-icon orange">
                            <i data-lucide="clock"></i>
                        </div>
                    </div>
                </div>

                <!-- 密钥表格区 -->
                <div class="table-section">
                    <div class="section-header">
                        <h2>密钥列表</h2>
                        <div class="header-actions">
                            <div class="search-box">
                                <i data-lucide="search"></i>
                                <input type="text" placeholder="搜索密钥..." id="searchInput" onkeyup="searchKeys()">
                            </div>
                            <div class="filter-dropdown">
                                <select id="statusFilter" onchange="filterByStatus()">
                                    <option value="all">全部状态</option>
                                    <option value="active">活跃</option>
                                    <option value="inactive">未激活</option>
                                    <option value="expired">已过期</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>服务商</th>
                                    <th>名称</th>
                                    <th>模型</th>
                                    <th>密钥预览</th>
                                    <th>状态</th>
                                    <th>过期时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="keysTableBody">
                                <!-- 数据将通过JS动态生成 -->
                            </tbody>
                        </table>
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <i data-lucide="inbox"></i>
                            <p>暂无API密钥</p>
                            <span>点击"添加密钥"开始管理您的API</span>
                        </div>
                    </div>
                </div>
                </div>
                <!-- /密钥管理页面 -->

                <!-- 使用统计页面 -->
                <div id="usagePage" style="display: none;">
                <!-- 页面标题区 -->
                <div class="page-title">
                    <div class="title-info">
                        <h1>使用统计</h1>
                        <p>查看 API 密钥使用情况和消耗分析</p>
                    </div>
                </div>

                <!-- 时间范围选择 -->
                <div class="usage-time-filter">
                    <button class="time-btn active" data-range="7" onclick="setTimeRange(7)">近 7 天</button>
                    <button class="time-btn" data-range="30" onclick="setTimeRange(30)">近 30 天</button>
                    <button class="time-btn" data-range="90" onclick="setTimeRange(90)">近 90 天</button>
                </div>

                <!-- 统计卡片行 -->
                <div class="stats-row usage-stats">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="totalRequests">0</div>
                            <div class="stat-label">总请求数</div>
                        </div>
                        <div class="stat-icon blue">
                            <i data-lucide="activity"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="totalTokens">0</div>
                            <div class="stat-label">Token 消耗</div>
                        </div>
                        <div class="stat-icon green">
                            <i data-lucide="zap"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="totalCost">$0</div>
                            <div class="stat-label">总成本</div>
                        </div>
                        <div class="stat-icon purple">
                            <i data-lucide="dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div class="stat-number" id="activeKeysUsage">0</div>
                            <div class="stat-label">活跃密钥</div>
                        </div>
                        <div class="stat-icon orange">
                            <i data-lucide="key"></i>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Token使用趋势</h3>
                            <span class="chart-subtitle">每日消耗统计</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="tokenChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>服务商分布</h3>
                            <span class="chart-subtitle">按Token消耗统计</span>
                        </div>
                        <div class="chart-container chart-pie">
                            <canvas id="providerChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 模型使用排行 -->
                <div class="table-section">
                    <div class="section-header">
                        <h2>模型使用排行</h2>
                        <span class="section-subtitle">按Token消耗排序</span>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>模型</th>
                                    <th>服务商</th>
                                    <th>请求数</th>
                                    <th>Token 消耗</th>
                                    <th>成本</th>
                                </tr>
                            </thead>
                            <tbody id="modelUsageTableBody">
                                <!-- 数据将通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
                <!-- /使用统计页面 -->

                <!-- 操作日志页面 -->
                <div id="logsPage" style="display: none;">
                <div class="page-title">
                    <div class="title-info">
                        <h1>操作日志</h1>
                        <p>查看您的账户操作记录</p>
                    </div>
                </div>

                <!-- 筛选区 -->
                <div class="logs-filter">
                    <div class="filter-group">
                        <label>操作类型</label>
                        <select id="logActionFilter" onchange="filterLogs()">
                            <option value="">全部操作</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>状态</label>
                        <select id="logStatusFilter" onchange="filterLogs()">
                            <option value="">全部状态</option>
                            <option value="success">成功</option>
                            <option value="failed">失败</option>
                        </select>
                    </div>
                </div>

                <!-- 日志表格 -->
                <div class="table-section">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>操作</th>
                                    <th>资源</th>
                                    <th>IP地址</th>
                                    <th>状态</th>
                                    <th>详情</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            </tbody>
                        </table>
                    </div>
                    <!-- 分页 -->
                    <div class="pagination" id="logsPagination">
                        <button class="page-btn" onclick="prevLogsPage()" id="logsPrevBtn" disabled>上一页</button>
                        <span class="page-info">第 <span id="logsCurrentPage">1</span> 页</span>
                        <button class="page-btn" onclick="nextLogsPage()" id="logsNextBtn">下一页</button>
                    </div>
                </div>
                </div>
                <!-- /操作日志页面 -->

                <!-- 安全中心页面 -->
                <div id="securityPage" style="display: none;">
                <div class="page-title">
                    <div class="title-info">
                        <h1>安全中心</h1>
                        <p>管理您的账户安全设置</p>
                    </div>
                </div>

                <!-- TOTP设置卡片 -->
                <div class="security-section">
                    <div class="security-card">
                        <div class="security-header">
                            <div class="security-icon totp">
                                <i data-lucide="smartphone"></i>
                            </div>
                            <div class="security-info">
                                <h3>双重认证 (TOTP)</h3>
                                <p>使用验证器应用进行两步验证</p>
                            </div>
                            <div class="security-status">
                                <span class="status-badge enabled" id="totpStatus">已启用</span>
                            </div>
                        </div>
                        <div class="security-actions">
                            <button class="btn-secondary" onclick="showRegenerateTOTP()">
                                <i data-lucide="refresh-cw"></i>
                                <span>重新生成密钥</span>
                            </button>
                            <button class="btn-secondary" onclick="showBackupCodes()">
                                <i data-lucide="key"></i>
                                <span>获取备用码</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 登录历史卡片 -->
                <div class="security-section">
                    <h2>登录历史</h2>
                    <p class="section-desc">查看最近的登录记录，确保账户安全</p>
                    
                    <div class="table-section">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>IP地址</th>
                                        <th>设备</th>
                                        <th>类型</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="loginHistoryBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="loginHistoryPagination">
                            <button class="page-btn" onclick="prevLoginPage()" id="loginPrevBtn" disabled>上一页</button>
                            <span class="page-info">第 <span id="loginCurrentPage">1</span> 页</span>
                            <button class="page-btn" onclick="nextLoginPage()" id="loginNextBtn">下一页</button>
                        </div>
                    </div>
                </div>

                <!-- 密钥余额卡片 -->
                <div class="security-section">
                    <h2>密钥余额</h2>
                    <p class="section-desc">查看各API密钥的余额和使用情况</p>
                    
                    <div class="balance-cards" id="balanceCards">
                        <!-- 动态生成 -->
                    </div>
                </div>

                <!-- 续费记录卡片 -->
                <div class="security-section">
                    <h2>续费记录</h2>
                    <p class="section-desc">查看您的续费历史</p>
                    
                    <div class="table-section">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>密钥</th>
                                        <th>金额</th>
                                        <th>有效期</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="renewalsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 危险操作区 -->
                <div class="security-section danger-zone">
                    <h2>危险操作</h2>
                    <p class="section-desc">以下操作不可逆，请谨慎操作</p>
                    
                    <div class="danger-actions">
                        <div class="danger-item">
                            <div class="danger-info">
                                <h4>修改密码</h4>
                                <p>更新您的登录密码</p>
                            </div>
                            <button class="btn-danger" onclick="showChangePassword()">
                                <i data-lucide="lock"></i>
                                <span>修改密码</span>
                            </button>
                        </div>
                        <div class="danger-item">
                            <div class="danger-info">
                                <h4>删除账户</h4>
                                <p>永久删除您的账户和所有数据</p>
                            </div>
                            <button class="btn-danger" onclick="showDeleteAccount()">
                                <i data-lucide="trash-2"></i>
                                <span>删除账户</span>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                <!-- /安全中心页面 -->
            </div>
        </main>
    </div>

    <!-- 添加/编辑密钥弹窗 -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">添加API密钥</h2>
                <button class="modal-close" onclick="closeAddModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="keyForm" class="modal-form" novalidate>
                <input type="hidden" id="keyId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="provider">API服务商 <span class="required">*</span></label>
                        <div class="select-wrapper">
                            <i data-lucide="server"></i>
                            <select id="provider" required onchange="onProviderChange()">
                                <option value="">请选择服务商</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="model">模型</label>
                        <div class="select-wrapper">
                            <i data-lucide="cpu"></i>
                            <select id="model" onchange="onModelChange()">
                                <option value="">请先选择服务商</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="keyName">密钥名称 <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <i data-lucide="tag"></i>
                            <input type="text" id="keyName" placeholder="如：生产环境密钥" required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="apiKey">API密钥 <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <i data-lucide="key"></i>
                            <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxx" required>
                            <button type="button" class="toggle-password" onclick="toggleKeyPassword()">
                                <i data-lucide="eye"></i>
                            </button>
                        </div>
                        <div class="api-key-actions">
                            <button type="button" class="btn-test-connection" id="testConnectionBtn" onclick="testApiConnection()">
                                测试连接
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-row test-result-row" id="testResultRow" style="display: none;">
                    <div class="test-result-card" id="testResultCard">
                        <div class="test-result-icon" id="testResultIcon"></div>
                        <div class="test-result-content">
                            <span class="test-result-title" id="testResultTitle">-</span>
                            <span class="test-result-message" id="testResultMessage">-</span>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="keyNote">备注</label>
                        <div class="input-wrapper textarea-wrapper">
                            <textarea id="keyNote" placeholder="添加备注信息..." rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">取消</button>
                    <button type="submit" class="btn-primary">
                        <i data-lucide="save"></i>
                        <span>保存</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 续费弹窗 -->
    <div class="modal-overlay" id="renewModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2>续费密钥</h2>
                <button class="modal-close" onclick="closeRenewModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="renewForm" onsubmit="event.preventDefault(); submitRenewal();">
                <input type="hidden" id="renewKeyId">
                <div class="modal-body">
                    <p class="renew-info">为密钥 <strong id="renewKeyName"></strong> 续费</p>
                    
                    <div class="form-group">
                        <label for="renewAmount">续费金额</label>
                        <div class="input-wrapper">
                            <i data-lucide="dollar-sign"></i>
                            <input type="number" id="renewAmount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="renewDays">有效期（天）</label>
                        <div class="input-wrapper">
                            <i data-lucide="calendar"></i>
                            <input type="number" id="renewDays" min="1" placeholder="30" value="30">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="renewNote">备注</label>
                        <textarea id="renewNote" placeholder="续费备注（可选）" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeRenewModal()">取消</button>
                    <button type="submit" class="btn-primary">
                        <i data-lucide="check"></i>
                        <span>确认续费</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2>确认删除</h2>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="warning-icon">
                    <i data-lucide="alert-triangle"></i>
                </div>
                <p>确定要删除此API密钥吗？</p>
                <span>此操作不可恢复</span>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button type="button" class="btn-danger" onclick="confirmDelete()">
                    <i data-lucide="trash-2"></i>
                    <span>删除</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 修改密码弹窗 -->
    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2>修改密码</h2>
                <button class="modal-close" onclick="closeChangePasswordModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="changePasswordForm" onsubmit="event.preventDefault(); submitChangePassword();">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="currentPassword">当前密码</label>
                        <div class="input-wrapper">
                            <i data-lucide="lock"></i>
                            <input type="password" id="currentPassword" required placeholder="输入当前密码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密码</label>
                        <div class="input-wrapper">
                            <i data-lucide="lock"></i>
                            <input type="password" id="newPassword" required placeholder="至少8位">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmNewPassword">确认新密码</label>
                        <div class="input-wrapper">
                            <i data-lucide="lock"></i>
                            <input type="password" id="confirmNewPassword" required placeholder="再次输入新密码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="totpForPassword">TOTP验证码</label>
                        <div class="input-wrapper">
                            <i data-lucide="shield-check"></i>
                            <input type="text" id="totpForPassword" maxlength="6" required placeholder="6位验证码">
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeChangePasswordModal()">取消</button>
                    <button type="submit" class="btn-primary">
                        <i data-lucide="check"></i>
                        <span>确认修改</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- 立即设置导航高亮，避免闪烁 -->
    <script>
        (function() {
            var initialPage = document.documentElement.getAttribute('data-initial-page');
            var navItems = {
                'keys': 'navKeyManage',
                'usage': 'navUsage',
                'logs': 'navLogs',
                'security': 'navSecurity'
            };
            var pageNames = {
                'keys': '密钥管理',
                'usage': '使用统计',
                'logs': '操作日志',
                'security': '安全中心'
            };
            
            // 移除所有 active
            Object.values(navItems).forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            
            // 设置当前页面高亮
            var navId = navItems[initialPage] || 'navKeyManage';
            var navEl = document.getElementById(navId);
            if (navEl) navEl.classList.add('active');
            
            var currentPageName = document.getElementById('currentPageName');
            if (currentPageName) {
                currentPageName.textContent = pageNames[initialPage] || '密钥管理';
            }
        })();
    </script>

    <script src="js/dashboard.js?v=20260218c"></script>
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
